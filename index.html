<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>CX Guidelines Tool</title>

	<link rel="stylesheet" href="1.css">
  </head>
  <body>

    <section id="content">
		<img src="https://www.vmware.com/etc/clientlibs/vmwaredevapp/clientlib-nav-redesign/images/vm-logo.png" alt="vmware"/>

		<p><a id="skiplink" href="#tableh2">Skip to the CX Guidelines Table</a></p> 

		<h1>CX Guidelines Tool</h1>
		<hr />

		<h2>Input Form</h2>
		<div id="inputFormContainer">
			<a href="entryForm.html">Enter a new Record</a> 
		</div>
		<hr />

		<h2>Column Sorting Controls</h2>
		<p>Select a radio button to set the sorting order of the table</p> 
		<div id="sortButtons"></div>
		<hr />

		<h2>Search</h2>
		<div id="searchContainer"></div> 
		<input type="submit" id="searchButton" value="Search">'
		<hr />

		<h2>Filter all columns using preset search terms</h2>
		<p>Filter all columns by one or more of the preset search terms below.</p> 
		<div id="presetFilterContainer"></div> 
 		<input id="presetFilterButton" type="submit" value="Submit Preset Filters"> 
		<hr />

		<h2>Column Filtering using user defined search terms</h2>
		<p>Enter a search term for one more columns using the form below.</p> 
		<div id="filterContainer"></div>
		<hr />

		<h2>Status</h2>

		<ul>
		<li><span id="count" aria-live="polite">0 results</span></li>
		<li><span id="sortStatus" aria-live="polite" data-sortcol="id" data-sortdir="DESC" data-filtercol="" data-filterstring=""></span></li>
		<li><span id="userDefinedAllFilterStatus" aria-live="polite">No user defined preset filters applied</span></li>
		<li><span id="presetFilterStatus" aria-live="polite">No filtering using preset fllter values against all columns has been applied</span></li>
		<li><span id="filterStatus" aria-live="polite">No filtering using user defined filter values against individual columns has been applied</span></li>
		<li><span id="searchStatus" aria-live="polite">No search terms have been applied</span></li>
		</ul>


		<hr />

		<h2 id="tableh2" tabindex="-1">CX Guidelines Table</h2>
		<section id="tableContainer"></section>

    </section>

	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

	<script>

		function getData(){
			let url = './getTableJSON.php';
			let jsonObjectsArray = [];
			$.ajax({
			  type: 'GET',
			  url: url,
			  dataType: 'json',
			  success: function(data) { jsonObjectsArray = data;},
			  async: false
			});
			return jsonObjectsArray;
		}

   		function getDataForSort(orderBy){
			let url = './getTableJSON.php?orderby=' + orderBy;
			let jsonObjectsArray = [];
			$.ajax({
			  type: "GET",
			  url: url,
			  dataType: 'json',
			  success: function(data) { jsonObjectsArray = data;},
			  async: false
			});
			return jsonObjectsArray;
		}

		function getFilteredData(query){
			let url = './filter.php?' + query;
			let jsonObjectsArray = [];
			$.ajax({
			  type: "GET",
			  url: url,
			  dataType: 'json',
			  success: function(data) { jsonObjectsArray = data;},
			  async: false
			});
			return jsonObjectsArray;
		}

		function getPresetFilteredData(searchTerms,sortCol,sortDir){
			let url = './presetFilter.php?searchTerms=' + searchTerms + '&sortCol=' + sortCol + '&sortDir=' + sortDir;
			console.log(url);
			let jsonObjectsArray = [];
			$.ajax({
			  type: "GET",
			  url: url,
			  dataType: 'json',
			  success: function(data) { jsonObjectsArray = data;},
			  async: false
			});
			return jsonObjectsArray;
		}
	
	    function init(){
			let jsonObjectsArray = getData(); 
		    createSortControls(jsonObjectsArray);  
			createFilterForm(jsonObjectsArray);//needs to come after the sort controls  
		    createPresetFilterForm();  
		    createSearchForm();  
			createTable(jsonObjectsArray);

			//manage skip link visibility
			$('#skiplink').focus(()=>{ 
				$('#skiplink').removeClass('offscreenText');
			});
			$('#skiplink').blur(()=>{ 
				$('#skiplink').addClass('offscreenText');
			});
			$('#skiplink').click(()=>{ 
				$('#tableh2').focus(); 
			});
		}

	    function sort(e){
			let orderBy = '';
            $("#sortButtons input[type=radio]:checked").each(function() { 
				sortColumn  = $(this).attr('data-sortcolumn'); 
				sortDirection = $(this).attr('data-sortdirection');
				orderBy += ' ' +  sortColumn + ' ' + sortDirection;
            });
            $('#sortStatus').text('Now sorting by' + orderBy); 
			//update status attributes in live region so filtering can be done with the correct sorting 
            $('#sortStatus').attr('data-sortcol', sortColumn); 
            $('#sortStatus').attr('data-sortdir', sortDirection); 
        	let jsonObjectsArray = getDataForSort(orderBy); 
			createTable(jsonObjectsArray);
		} 

		function filter(){
			let length = $("#filterContainer input[type='text']").length;
			let query = '';
			let sortCol = $("#sortStatus").attr('data-sortcol'); 
			let sortDir = $("#sortStatus").attr('data-sortdir'); 
            let filterCols = [];
 			let filterStrings = []; 
            $("#filterContainer input[type='text']").each(function(index) { 
				filterColumn  = $(this).attr('name'); 
				filterString = $(this).val();
				if(filterString.length > 0){
					filterCols.push(filterColumn); 
					filterStrings.push(filterString); 
				}
				query += filterColumn + '=' + filterString;
				if (index !== (length - 1)){
					query += '&';
				}
            });
			query += '&';
			query += 'filter_sort_column=' + sortCol;
			query += '&';
			query += 'filter_sort_direction=' + sortDir;
        	let jsonObjectsArray = getFilteredData(query); 
			createTable(jsonObjectsArray);
            let filterMessage = '';
			for(let i = 0; i < filterCols.length; i++) {
				filterMessage += filterCols[i];
				filterMessage += ' like ';
				filterMessage += '"';
				filterMessage += filterStrings[i];
				filterMessage += '"';
				if(i < filterCols.length - 1){
					filterMessage += ' AND ';
				}
			}
            $('#filterStatus').text('Now filtering by: ' +  filterMessage); 

		}

		function search() {
			let sortCol = $("#sortStatus").attr('data-sortcol'); 
			let sortDir = $("#sortStatus").attr('data-sortdir');
			let searchTerms = [];
            let searchTerm = $("#searchInput").val();
			searchTerms.push(searchTerm);//passing single item as array to use getPresetFilteredData() 
			let jsonObjectsArray = getPresetFilteredData(searchTerms,sortCol,sortDir); 
			createTable(jsonObjectsArray);
			$('#searchStatus').text('Now displaying results the from search term "' + searchTerm + '"');  
		} 

		function presetFilter(){

			let sortCol = $("#sortStatus").attr('data-sortcol'); 
			let sortDir = $("#sortStatus").attr('data-sortdir'); 
			let searchTerms = []; 
			let length = $("#presetFilterContainer input[type='checkbox']:checked").length;

            $("#presetFilterContainer input[type='checkbox']:checked").each(function() {
				searchTerms.push($(this).val());
	        }); 
	
			let jsonObjectsArray = getPresetFilteredData(searchTerms,sortCol,sortDir); 

			createTable(jsonObjectsArray);

			let filterMessage = '';
			for(let i = 0; i < searchTerms.length; i++) {
				filterMessage += '"';
				filterMessage += searchTerms[i];
				filterMessage += '"';
				if(i < searchTerms.length - 1){
					filterMessage += ', ';
				} 
			}
            $('#presetFilterStatus').text('Now filtering all columns by the following preset search terms: ' + filterMessage ); 

		}

		function createFilterForm(jsonObjectsArray) {
			let filterForm = '';	
			let defaultSortColumn = 'id';
	 		let defaultSortDirection = 'DESC'; 

			for (let key in jsonObjectsArray[0]) {
				if(key !== 'id'){
					filterForm += '<label for="' + key + 'filterInput"' + '>';
					filterForm += 'Where ' +  key + ' contains: '; 
					filterForm += '</label>';
					filterForm += '<input type="text" id="' + key + 'filterInput"' + 'name="' + key + '">';
				} 
			}

            filterForm += '<input type="submit" value="Filter">'; 
			$('#filterContainer').html(filterForm);
			$('#filterContainer input[type="submit"]').click(()=>{filter();});
		} 
			
		function createPresetFilterForm() {
			let searchStrings = ['test', 'testqqreqre', 'tttt']; 
			let presetFilterForm = '';	
			let defaultSortColumn = 'id';
	 		let defaultSortDirection = 'DESC';

			let orderBy = 'ORDER BY ' +  defaultSortColumn + defaultSortDirection;
            
			for(let i=0; i < searchStrings.length; i++){
				presetFilterForm += '<div class="checkboxContainer">';
				presetFilterForm += '<input type="checkbox" id="presetSearchTerm_' + i + '"';
				presetFilterForm += ' value="' + searchStrings[i] + '"';
				presetFilterForm += '>';
				presetFilterForm += '<label for="presetSearchTerm_' + i + '"' + '">';
				presetFilterForm += searchStrings[i];
				presetFilterForm += '</label>';
				presetFilterForm += '</div>';

			} 

			$('#presetFilterContainer').html(presetFilterForm);
			$('#presetFilterButton').click(()=>{presetFilter();});

		} 

		function createSearchForm(){
			let searchForm = '';	
			let id = 'searchInput';	
			searchForm += '<label for="' + id + '">';
			searchForm += 'Enter Search Term';
			searchForm += '</label>';
			searchForm += '<input type="text" id="' + id + '">';

			$('#searchContainer').html(searchForm);
			$('#searchButton').click(()=>{search();});
		} 

		function createSortControls(jsonObjectsArray) {
			let	sortButtonsHtmlString = ''; 
			let tableHtmlString;
			let radioName = "sort";
			sortButtonsHtmlString += '<div role="radiogroup" aria-label="sorting choices">';
			for (let key in jsonObjectsArray[0]) {
				//sort ascending radio buttons
				sortButtonsHtmlString += '<div class="sortRadio">';
				sortButtonsHtmlString += '<input type="radio" name="' + radioName + '" ' + 'data-sortcolumn="' + key + '" '  + 'data-sortdirection="ASC"' + ' id="' + key + '_ascending">';
				sortButtonsHtmlString += '<label for="' + key + '_ascending">';
				sortButtonsHtmlString += key; 
				sortButtonsHtmlString += '<span class="offscreenText">'; 
				sortButtonsHtmlString += 'sort'; 
				sortButtonsHtmlString += ' ascending'; 
				sortButtonsHtmlString += '</span>'; 
				sortButtonsHtmlString += '<span class="sortArrow" aria-hidden="true">'; 
				sortButtonsHtmlString += '&uarr;'; 
				sortButtonsHtmlString += '</span>'; 
				sortButtonsHtmlString += '</label>';
				sortButtonsHtmlString += '</div>';

				//sort descending radio buttons
				sortButtonsHtmlString += '<div class="sortRadio">';
				sortButtonsHtmlString += '<input type="radio" name="' + radioName + '" ' + 'data-sortcolumn="' + key + '" '  + 'data-sortdirection="DESC"' + ' id="' + key + '_descending">';
				sortButtonsHtmlString += '<label for="' + key + '_descending">';
				sortButtonsHtmlString += key; 
				sortButtonsHtmlString += '<span class="offscreenText">'; 
				sortButtonsHtmlString += 'sort'; 
				sortButtonsHtmlString += ' descending'; 
				sortButtonsHtmlString += '</span>'; 
				sortButtonsHtmlString += '<span class="sortArrow" aria-hidden="true">'; 
				sortButtonsHtmlString += '&darr;'; 
				sortButtonsHtmlString += '</span>'; 
				sortButtonsHtmlString += '</label>'; 
				sortButtonsHtmlString += '</div>';
			}

			sortButtonsHtmlString += '</div>';
			$('#sortButtons').html(sortButtonsHtmlString);
            $('#sortStatus').text('Now sorting by id descending'); 
            $('#id_descending').attr('checked','checked'); 
			$('#sortButtons input[type="radio"]').click((e)=>{sort(e)});
		}

    	function createTable(jsonObjectsArray){
            tableHtmlString = '<table>';
			tableHtmlString += '<tr>';
			for (let key in jsonObjectsArray[0]) {
				tableHtmlString += '<th>';
				tableHtmlString += key; 
				tableHtmlString += '</th>';
			}
			tableHtmlString += '</tr>';
			for(let i = 0; i < jsonObjectsArray.length; i++) {
				tableHtmlString += '<tr>';		
				for (let key in jsonObjectsArray[i]) {
					tableHtmlString += '<td>';		
					if(key === 'id'){
						tableHtmlString += jsonObjectsArray[i][key];	
						tableHtmlString += '&nbsp;<a class="manageLink"href="manageRecord.php?id=' + jsonObjectsArray[i][key] + '">';	
						tableHtmlString += 'manage record ';	
						tableHtmlString += '<span class="offscreenText">';	
						tableHtmlString += jsonObjectsArray[i][key];	
						tableHtmlString += '</span>'; 	
						tableHtmlString += '</a>';	
					} else {
						tableHtmlString += jsonObjectsArray[i][key];	
					} 	
					tableHtmlString += '</td>';		
				}		
				tableHtmlString += '</tr>';		
			}
			tableHtmlString += "</table>";
			$('#tableContainer').html(tableHtmlString);
			$('#count').text('Result count:  ' + jsonObjectsArray.length);
		}
		
		init();  

	</script>

  </body>
</html>

